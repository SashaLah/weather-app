<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="default">
   <meta name="format-detection" content="telephone=no">
   <title>Birthday Weather Time Machine</title>
   
   <!-- Google Analytics (GA4) -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-38RTREJJ2S"></script>
   <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'G-38RTREJJ2S');
   </script>
   
   <!-- DOMPurify for security -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.3/purify.min.js"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   <style>
       /* Original styles */
       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           max-width: 800px;
           margin: 0 auto;
           padding: 20px;
           background-color: #f8f9fa;
           -webkit-font-smoothing: antialiased;
           -moz-osx-font-smoothing: grayscale;
       }
       .header {
           text-align: center;
           color: #2c3e50;
           margin-bottom: 30px;
       }
       .subtitle {
           color: #666;
           text-align: center;
           margin-bottom: 25px;
           font-size: 1.1em;
       }
       #searchInput, select {
           width: 200px;
           padding: 12px;
           font-size: 16px;
           margin-right: 10px;
           border: 1px solid #ddd;
           border-radius: 6px;
           -webkit-appearance: none;
       }
       #weatherResult {
           margin-top: 20px;
           padding: 20px;
           border: 1px solid #ddd;
           border-radius: 8px;
           background-color: white;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
           text-align: center;
       }
       .dob-container {
           display: flex;
           margin-top: 20px;
           margin-bottom: 20px;
           justify-content: center;
           gap: 15px;
       }
       .search-container {
           text-align: center;
           margin: 20px 0;
       }
       .search-button {
           padding: 12px 25px;
           background-color: #3498db;
           color: white;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           margin-top: 20px;
           font-size: 16px;
           transition: background-color 0.3s;
           display: none;
           -webkit-appearance: none;
       }
       .search-button:hover {
           background-color: #2980b9;
       }
       .error-message {
           color: #e74c3c;
           margin-top: 10px;
       }
       .toggle-container {
           margin: 20px 0;
           text-align: center;
       }
       .switch {
           position: relative;
           display: inline-block;
           width: 60px;
           height: 34px;
           margin: 0 10px;
       }
       .switch input {
           opacity: 0;
           width: 0;
           height: 0;
       }
       .slider {
           position: absolute;
           cursor: pointer;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background-color: #3498db;
           transition: .4s;
           border-radius: 34px;
       }
       .slider:before {
           position: absolute;
           content: "";
           height: 26px;
           width: 26px;
           left: 4px;
           bottom: 4px;
           background-color: white;
           transition: .4s;
           border-radius: 50%;
       }
       input:checked + .slider {
           background-color: #2ecc71;
       }
       input:checked + .slider:before {
           transform: translateX(26px);
       }
       .temp-label {
           display: inline-block;
           font-weight: bold;
           color: #2c3e50;
       }
       .weather-icon {
           font-size: 120px !important;
           text-align: center;
           margin: 30px 0;
           line-height: 1;
           display: block;
       }
       .mode-selector {
           text-align: center;
           margin-bottom: 20px;
       }
       .mode-button {
           padding: 10px 20px;
           margin: 0 10px;
           cursor: pointer;
           border: none;
           border-radius: 5px;
           background-color: #ecf0f1;
           -webkit-appearance: none;
       }
       .mode-button.active {
           background-color: #3498db;
           color: white;
       }
       #friendNameInput {
           display: none;
           width: 200px;
           padding: 12px;
           margin: 10px auto;
           border: 1px solid #ddd;
           border-radius: 6px;
           text-align: center;
           -webkit-appearance: none;
       }
       .friend-input-container {
           text-align: center;
           margin: 10px 0;
       }
       .share-container {
           margin-top: 30px;
           text-align: center;
           width: 100%;
           display: block !important;
           position: static !important;
           opacity: 1 !important;
           visibility: visible !important;
           -webkit-transform: none !important;
           transform: none !important;
       }
       .share-trigger {
           background-color: #3498db;
           color: white;
           padding: 12px 25px;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           font-size: 16px;
           display: inline-flex !important;
           align-items: center;
           gap: 8px;
           width: auto;
           margin: 0 auto;
           -webkit-appearance: none;
           -webkit-display: inline-flex !important;
           display: -webkit-inline-flex !important;
           position: static !important;
           opacity: 1 !important;
           visibility: visible !important;
           z-index: 1000;
           touch-action: manipulation;
       }
       .share-trigger:hover {
           background-color: #2980b9;
       }
       .weather-description {
           font-size: 1.2em;
           margin: 20px 0;
           text-align: center;
           color: #2c3e50;
           line-height: 1.6;
           padding: 0 10px;
       }
       .birthday-message {
           font-size: 1.5em;
           margin: 15px 0;
           text-align: center;
           color: #2c3e50;
           line-height: 1.6;
           font-weight: bold;
       }
       .temp-info {
           margin: 15px 0;
           font-size: 1.1em;
           color: #2c3e50;
       }

       /* New horoscope styles */
       .horoscope-section {
           margin-top: 30px;
           padding: 20px;
           background-color: #ffffff;
           border-radius: 8px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.1);
       }

       .horoscope-title {
           color: #2c3e50;
           font-size: 1.4em;
           margin-bottom: 20px;
           text-align: center;
           font-weight: bold;
       }

       .horoscope-mood {
           font-size: 1.2em;
           color: #34495e;
           text-align: center;
           margin: 15px 0;
           font-style: italic;
           line-height: 1.6;
       }

       .personality-traits {
           list-style: none;
           padding: 0;
           margin: 20px 0;
       }

       .personality-trait {
           background-color: #f8f9fa;
           border-radius: 6px;
           padding: 12px;
           margin: 10px 0;
           color: #2c3e50;
           font-size: 1.1em;
           text-align: center;
           border-left: 4px solid #3498db;
           transition: transform 0.2s ease;
       }

       .personality-trait:hover {
           transform: translateX(5px);
       }

       /* Original mobile styles */
       @media (max-width: 768px) {
           body {
               padding: 10px;
               -webkit-overflow-scrolling: touch;
           }
           
           .dob-container {
               flex-direction: column;
               align-items: center;
               gap: 10px;
           }
           
           #searchInput, select {
               width: 100%;
               max-width: 300px;
               margin: 5px 0;
           }
           
           .ui-autocomplete {
               max-width: 300px;
               word-wrap: break-word;
           }

           .mode-button {
               margin: 5px;
               width: calc(50% - 20px);
           }

           .share-trigger {
               display: inline-flex !important;
               width: auto !important;
               min-width: 200px;
               margin: 10px auto !important;
               position: relative !important;
               z-index: 1000;
               -webkit-tap-highlight-color: transparent;
           }

           .share-container {
               display: block !important;
               width: 100% !important;
               visibility: visible !important;
               margin: 20px 0;
               position: relative !important;
               z-index: 1000;
           }

           .weather-icon {
               font-size: 100px !important;
           }

           .weather-description {
               padding: 0 15px;
           }

           /* New mobile horoscope styles */
           .horoscope-section {
               margin: 20px 5px;
               padding: 15px;
           }

           .personality-trait {
               font-size: 1em;
               padding: 10px;
               margin: 8px 0;
           }
       }

       /* Original Safari-specific fixes */
       @supports (-webkit-touch-callout: none) {
           .share-container {
               position: relative !important;
               opacity: 1 !important;
               visibility: visible !important;
               -webkit-transform: none !important;
               transform: none !important;
               z-index: 1000;
           }
           
           .share-trigger {
               opacity: 1 !important;
               visibility: visible !important;
               -webkit-appearance: none;
               display: -webkit-inline-box !important;
               display: -webkit-inline-flex !important;
               position: relative !important;
               z-index: 1000;
               cursor: pointer;
               -webkit-tap-highlight-color: transparent;
           }
       }

       /* Original autocomplete improvements */
       .ui-autocomplete {
           max-height: 50vh;
           overflow-y: auto;
           -webkit-overflow-scrolling: touch;
           z-index: 9999;
           background-color: white;
           border-radius: 6px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
           border: 1px solid #ddd;
       }

       .ui-menu-item {
           padding: 8px 12px;
           cursor: pointer;
           transition: background-color 0.2s;
       }

       .ui-menu-item:hover {
           background-color: #f5f5f5;
       }

       .ui-menu-item .ui-menu-item-wrapper.ui-state-active {
           background-color: #3498db;
           color: white;
           border: none;
           margin: 0;
       }
   </style>
</head>
<body>
   <div class="header">
       <h1>Birthday Weather Time Machine</h1>
       <div class="subtitle">Discover what the weather was like on your Birthday day!</div>
   </div>

   <div class="mode-selector">
       <button class="mode-button active" data-mode="personal">My Birthday</button>
       <button class="mode-button" data-mode="friend">Friend's Birthday</button>
   </div>

   <div class="friend-input-container">
       <input type="text" id="friendNameInput" placeholder="Enter friend's name">
   </div>
   
   <div class="dob-container">
       <select id="dobMonth"></select>
       <select id="dobDay"></select>
       <select id="dobYear"></select>
   </div>

   <div class="search-container">
       <input type="text" id="searchInput" placeholder="Enter birthplace">
       <button id="getWeather" class="search-button">Get Weather</button>
   </div>
   
   <div class="toggle-container">
       <span class="temp-label">°F</span>
       <label class="switch">
           <input type="checkbox" id="tempToggle">
           <span class="slider"></span>
       </label>
       <span class="temp-label">°C</span>
   </div>

   <div id="weatherResult"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
    $(document).ready(function() {
        let selectedCity = null;
        let isFahrenheit = true;

        function sanitizeInput(input) {
            return DOMPurify.sanitize(input.trim());
        }

        // [Previous JavaScript functions remain the same until checkWeather success callback]

        function checkWeather() {
            if (!selectedCity) return;
            
            const year = $('#dobYear').val();
            const month = $('#dobMonth').val();
            const day = $('#dobDay').val();
            const date = `${year}-${month}-${day}`;
            const isFriendMode = $('.mode-button.active').data('mode') === 'friend';
            const friendName = isFriendMode ? sanitizeInput($('#friendNameInput').val()) : '';

            gtag('event', 'search_weather', {
                'mode': isFriendMode ? 'friend' : 'personal',
                'city': selectedCity.city,
                'year': year
            });

            $('#weatherResult').html('<div class="loading">Loading...</div>');

            $.ajax({
                url: "/weather",
                data: {
                    latitude: selectedCity.latitude,
                    longitude: selectedCity.longitude,
                    date: date
                },
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(data) {
                    if (data.daily && data.daily.temperature_2m_max) {
                        const maxTemp = isFahrenheit ? 
                            celsiusToFahrenheit(data.daily.temperature_2m_max[0]).toFixed(1) : 
                            data.daily.temperature_2m_max[0].toFixed(1);
                        const minTemp = isFahrenheit ? 
                            celsiusToFahrenheit(data.daily.temperature_2m_min[0]).toFixed(1) : 
                            data.daily.temperature_2m_min[0].toFixed(1);
                        const unit = isFahrenheit ? '°F' : '°C';
                        const weatherIcon = getWeatherIcon(data.daily.weathercode[0]);
                        const timeDiff = getTimeDifference(`${year}-${month}-${day}`);
                        
                        const timeLocation = `in ${selectedCity.city}, ${timeDiff} ago`;
                        let headerText;
                        
                        if (isFriendMode) {
                            headerText = `Happy Birthday, ${friendName}!`;
                        } else {
                            headerText = 'On your birthday';
                        }

                        const weatherDesc = getWeatherDescription(
                            data.daily.weathercode[0], 
                            data.daily.temperature_2m_max[0], 
                            data.daily.temperature_2m_min[0],
                            isFahrenheit
                        );

                        let resultHTML = `
                            <div class="weather-icon">${weatherIcon}</div>
                            <h3 class="birthday-message">${sanitizeInput(headerText)}</h3>
                            <div class="weather-description">
                                <p>The weather ${timeLocation}:</p>
                                <p>${weatherDesc}</p>
                            </div>
                            <div class="temp-info">
                                <p>High Temperature: ${maxTemp}${unit}</p>
                                <p>Low Temperature: ${minTemp}${unit}</p>
                                <p>Precipitation: ${data.daily.precipitation_sum[0]} mm</p>
                            </div>`;

                        // Add horoscope section if available
                        if (data.horoscope) {
                            resultHTML += `
                                <div class="horoscope-section">
                                    <h3 class="horoscope-title">Your Weather Personality</h3>
                                    <div class="horoscope-mood">${sanitizeInput(data.horoscope.weather_summary)}</div>
                                    <div class="horoscope-mood">${sanitizeInput(data.horoscope.temperature_insight)}</div>
                                    <ul class="personality-traits">
                                        ${data.horoscope.personality_traits.map(trait => 
                                            `<li class="personality-trait">${sanitizeInput(trait)}</li>`
                                        ).join('')}
                                    </ul>
                                </div>`;
                        }

                        resultHTML += `
                            <div class="share-container">
                                <button class="share-trigger" onclick="shareResults('${sanitizeInput(headerText)} ${timeLocation}. ${weatherDesc}${data.horoscope ? '\n\n🌟 Weather Personality:\n' + data.horoscope.personality_traits.join('\n')}')">
                                    <i class="fas fa-share-alt"></i> Share Results
                                </button>
                            </div>`;

                        $('#weatherResult').html(resultHTML);

                        gtag('event', 'view_weather_result', {
                            'weather_code': data.daily.weathercode[0],
                            'city': selectedCity.city
                        });
                    } else {
                        $('#weatherResult').html('<p class="error-message">Weather data not available for this date</p>');
                        gtag('event', 'error', {
                            'error_type': 'no_weather_data',
                            'city': selectedCity.city
                        });
                    }
                },
                error: function(err) {
                    $('#weatherResult').html('<p class="error-message">Failed to fetch weather data</p>');
                    gtag('event', 'error', {
                        'error_type': 'api_error',
                        'city': selectedCity.city
                    });
                }
            });
        }

        $('#dobDay, #dobMonth, #dobYear, #friendNameInput').on('change', checkFormCompletion);
        $('#friendNameInput').on('input', checkFormCompletion);
        $('#getWeather').on('click', checkWeather);
        $('#tempToggle').on('change', function() {
            isFahrenheit = !this.checked;
            if($('#weatherResult').html()) {
                checkWeather();
            }
            gtag('event', 'toggle_temperature_unit', {
                'unit': isFahrenheit ? 'fahrenheit' : 'celsius'
            });
        });

        yearSelect.on('focus', function() {
            var defaultOption = $(this).find('option[value="2000"]');
            var defaultIndex = defaultOption.index();
            var selectElement = this;
            
            setTimeout(function() {
                selectElement.scrollTop = defaultOption.offset().top - selectElement.offsetTop - (selectElement.offsetHeight / 2) + (defaultOption.height() / 2);
            }, 0);
        });
    });

    function shareResults(messageText) {
        const decodedMessage = decodeURIComponent(messageText);
        if (navigator.share) {
            navigator.share({
                title: 'Birthday Weather Time Machine',
                text: sanitizeInput(decodedMessage)
            }).catch((err) => {
                if (err.name !== 'AbortError') {
                    console.error('Error sharing:', err);
                    gtag('event', 'share_error', {
                        'error_type': err.name
                    });
                }
            });
        }
    }
</script>
</body>
</html>