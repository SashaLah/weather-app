<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="default">
   <meta name="format-detection" content="telephone=no">
   <title>Birthday Weather Time Machine</title>
   <!-- Google Analytics (GA4) -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-38RTREJJ2S"></script>
   <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-38RTREJJ2S');
   </script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   <style>
       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           max-width: 800px;
           margin: 0 auto;
           padding: 20px;
           background-color: #f8f9fa;
           -webkit-font-smoothing: antialiased;
           -moz-osx-font-smoothing: grayscale;
       }
       .header {
           text-align: center;
           color: #2c3e50;
           margin-bottom: 30px;
       }
       .subtitle {
           color: #666;
           text-align: center;
           margin-bottom: 25px;
           font-size: 1.1em;
       }
       #searchInput, select {
           width: 200px;
           padding: 12px;
           font-size: 16px;
           margin-right: 10px;
           border: 1px solid #ddd;
           border-radius: 6px;
           -webkit-appearance: none;
       }
       #weatherResult {
           margin-top: 20px;
           padding: 20px;
           border: 1px solid #ddd;
           border-radius: 8px;
           background-color: white;
           box-shadow: 0 2px 4px rgba(0,0,0,0.1);
           text-align: center;
       }
       .dob-container {
           display: flex;
           margin-top: 20px;
           margin-bottom: 20px;
           justify-content: center;
           gap: 15px;
       }
       .search-container {
           text-align: center;
           margin: 20px 0;
       }
       .search-button {
           padding: 12px 25px;
           background-color: #3498db;
           color: white;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           margin-top: 20px;
           font-size: 16px;
           transition: background-color 0.3s;
           display: none;
           -webkit-appearance: none;
       }
       .search-button:hover {
           background-color: #2980b9;
       }
       .error-message {
           color: #e74c3c;
           margin-top: 10px;
       }
       .toggle-container {
           margin: 20px 0;
           text-align: center;
       }
       .switch {
           position: relative;
           display: inline-block;
           width: 60px;
           height: 34px;
           margin: 0 10px;
       }
       .switch input {
           opacity: 0;
           width: 0;
           height: 0;
       }
       .slider {
           position: absolute;
           cursor: pointer;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background-color: #3498db;
           transition: .4s;
           border-radius: 34px;
       }
       .slider:before {
           position: absolute;
           content: "";
           height: 26px;
           width: 26px;
           left: 4px;
           bottom: 4px;
           background-color: white;
           transition: .4s;
           border-radius: 50%;
       }
       input:checked + .slider {
           background-color: #2ecc71;
       }
       input:checked + .slider:before {
           transform: translateX(26px);
       }
       .temp-label {
           display: inline-block;
           font-weight: bold;
           color: #2c3e50;
       }
       .weather-icon {
           font-size: 120px !important;
           text-align: center;
           margin: 30px 0;
           line-height: 1;
           display: block;
       }
       .mode-selector {
           text-align: center;
           margin-bottom: 20px;
       }
       .mode-button {
           padding: 10px 20px;
           margin: 0 10px;
           cursor: pointer;
           border: none;
           border-radius: 5px;
           background-color: #ecf0f1;
           -webkit-appearance: none;
       }
       .mode-button.active {
           background-color: #3498db;
           color: white;
       }
       #friendNameInput {
           display: none;
           width: 200px;
           padding: 12px;
           margin: 10px auto;
           border: 1px solid #ddd;
           border-radius: 6px;
           text-align: center;
           -webkit-appearance: none;
       }
       .friend-input-container {
           text-align: center;
           margin: 10px 0;
       }

       /* Updated share button styles */
       .share-container {
           margin: 30px 0;
           text-align: center;
           position: relative;
           z-index: 9999;
       }
       
       .share-trigger {
           background-color: #3498db;
           color: white;
           padding: 12px 25px;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           font-size: 16px;
           display: inline-flex;
           align-items: center;
           gap: 8px;
           -webkit-appearance: none;
           position: relative;
           z-index: 9999;
           transition: background-color 0.3s, transform 0.2s;
       }

       .share-trigger:hover {
           background-color: #2980b9;
           transform: translateY(-1px);
       }

       .share-trigger:active {
           transform: translateY(1px);
       }

       .share-trigger i {
           font-size: 18px;
       }

       /* Toast notification for copy feedback */
       .toast {
           position: fixed;
           bottom: 20px;
           left: 50%;
           transform: translateX(-50%);
           background-color: #2ecc71;
           color: white;
           padding: 12px 24px;
           border-radius: 6px;
           font-size: 16px;
           display: none;
           z-index: 10000;
           box-shadow: 0 2px 8px rgba(0,0,0,0.2);
           animation: fadeInUp 0.3s ease;
       }

       @keyframes fadeInUp {
           from {
               opacity: 0;
               transform: translate(-50%, 20px);
           }
           to {
               opacity: 1;
               transform: translate(-50%, 0);
           }
       }
       
       .weather-description {
           font-size: 1.2em;
           margin: 20px 0;
           text-align: center;
           color: #2c3e50;
           line-height: 1.6;
           padding: 0 10px;
       }
       .birthday-message {
           font-size: 1.5em;
           margin: 15px 0;
           text-align: center;
           color: #2c3e50;
           line-height: 1.6;
           font-weight: bold;
       }
       .temp-info {
           margin: 15px 0;
           font-size: 1.1em;
           color: #2c3e50;
       }
       
       .horoscope-container {
           margin: 30px 0;
           padding: 20px;
           background-color: #f8f9fa;
           border-radius: 12px;
           border: 1px solid #e9ecef;
       }
       .horoscope-header {
           color: #2c3e50;
           font-size: 1.3em;
           margin-bottom: 20px;
           text-align: center;
           font-weight: bold;
       }
       .horoscope-grid {
           display: grid;
           grid-template-columns: 1fr 1fr;
           gap: 20px;
           margin-top: 20px;
       }
       .horoscope-column {
           background: white;
           padding: 20px;
           border-radius: 8px;
           box-shadow: 0 2px 4px rgba(0,0,0,0.05);
       }
       .horoscope-title {
           color: #3498db;
           font-weight: bold;
           margin-bottom: 10px;
           font-size: 1.1em;
       }
       .horoscope-text {
           color: #2c3e50;
           line-height: 1.6;
       }

       /* Safari-specific fixes */
       @supports (-webkit-touch-callout: none) {
           .share-trigger {
               display: -webkit-box !important;
               display: -webkit-inline-flex !important;
               -webkit-appearance: button;
               -webkit-tap-highlight-color: transparent;
               position: relative !important;
               z-index: 9999 !important;
               opacity: 1 !important;
               visibility: visible !important;
               transform: none !important;
               margin: 10px auto !important;
           }
           
           .share-container {
               display: block !important;
               position: relative !important;
               z-index: 9999 !important;
               opacity: 1 !important;
               visibility: visible !important;
               transform: none !important;
           }
       }

       /* Mobile-specific styles */
       @media (max-width: 768px) {
           body {
               padding: 10px;
           }
           
           .dob-container {
               flex-direction: column;
               align-items: center;
               gap: 10px;
           }
           
           #searchInput, select {
               width: 100%;
               max-width: 300px;
               margin: 5px 0;
           }
           
           .horoscope-grid {
               grid-template-columns: 1fr;
           }
           
           .weather-icon {
               font-size: 100px !important;
           }
           
           .share-trigger {
               width: auto !important;
               min-width: 200px !important;
               margin: 10px auto !important;
               display: -webkit-inline-flex !important;
               position: relative !important;
               z-index: 9999 !important;
           }

           .share-container {
               margin: 20px 0 !important;
               display: block !important;
               position: relative !important;
               z-index: 9999 !important;
           }
       }

   </style>
</head>
<body>
   <div class="header">
       <h1>Birthday Weather Time Machine</h1>
       <div class="subtitle">Discover what the weather was like on the day you were born!</div>
   </div>

   <div class="mode-selector">
       <button class="mode-button active" data-mode="personal">My Birthday</button>
       <button class="mode-button" data-mode="friend">Friend's Birthday</button>
   </div>

   <div class="friend-input-container">
       <input type="text" id="friendNameInput" placeholder="Enter friend's name">
   </div>
   
   <div class="dob-container">
       <select id="dobMonth"></select>
       <select id="dobDay"></select>
       <select id="dobYear"></select>
   </div>

   <div class="search-container">
       <input type="text" id="searchInput" placeholder="Enter birthplace">
       <button id="getWeather" class="search-button">Get Weather</button>
   </div>
   
   <div class="toggle-container">
       <span class="temp-label">°F</span>
       <label class="switch">
           <input type="checkbox" id="tempToggle">
           <span class="slider"></span>
       </label>
       <span class="temp-label">°C</span>
   </div>

   <div id="weatherResult"></div>
   
   <!-- Toast notification -->
   <div class="toast" id="toast"></div>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
   <script>
       $(document).ready(function() {
           let selectedCity = null;
           let isFahrenheit = true;

           // Toast notification function
           function showToast(message, duration = 3000) {
               const toast = $('#toast');
               toast.text(message).fadeIn();
               setTimeout(() => toast.fadeOut(), duration);
           }

           $('.mode-button').click(function() {
               $('.mode-button').removeClass('active');
               $(this).addClass('active');
               const mode = $(this).data('mode');
               $('#friendNameInput').toggle(mode === 'friend');
               updatePlaceholders(mode);
           });

           function updatePlaceholders(mode) {
               const searchPlaceholder = mode === 'friend' ? "Enter friend's birthplace" : "Enter your birthplace";
               $('#searchInput').attr('placeholder', searchPlaceholder);
           }

           var monthSelect = $('#dobMonth');
           var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
           for (var i = 0; i < 12; i++) {
               monthSelect.append($('<option></option>').val((i+1).toString().padStart(2, '0')).html(months[i]));
           }

           var daySelect = $('#dobDay');
           for (var i = 1; i <= 31; i++) {
               daySelect.append($('<option></option>').val(i.toString().padStart(2, '0')).html(i));
           }

           var yearSelect = $('#dobYear');
           var currentYear = new Date().getFullYear();
           for (var i = currentYear; i >= 1940; i--) {
               yearSelect.append($('<option></option>').val(i).html(i));
           }
           yearSelect.val(2000);

           function celsiusToFahrenheit(celsius) {
               return (celsius * 9/5) + 32;
           }

           function getWeatherIcon(weatherCode) {
               const weatherIcons = {
                   0: '☀️', 1: '🌤️', 2: '⛅', 3: '☁️', 45: '🌫️', 48: '🌫️',
                   51: '🌧️', 53: '🌧️', 55: '🌧️', 61: '🌧️', 63: '🌧️', 65: '🌧️',
                   71: '🌨️', 73: '🌨️', 75: '🌨️', 77: '🌨️', 80: '🌧️', 81: '🌧️',
                   82: '🌧️', 85: '🌨️', 86: '🌨️', 95: '⛈️', 96: '⛈️', 99: '⛈️'
               };
               return weatherIcons[weatherCode] || '❓';
           }

           function getTemperatureDescription(maxTemp, isFahrenheit) {
               const temp = isFahrenheit ? maxTemp : celsiusToFahrenheit(maxTemp);
               if (temp >= 90) return "a scorching hot";
               if (temp >= 80) return "a very warm";
               if (temp >= 70) return "a pleasantly warm";
               if (temp >= 60) return "a mild";
               if (temp >= 50) return "a cool";
               if (temp >= 40) return "a chilly";
               if (temp >= 30) return "a cold";
               return "a very cold";
           }

           function getWeatherDescription(weatherCode, maxTemp, minTemp, precipitation, isFahrenheit) {
               const baseDescriptions = {
                   0: "clear and sunny day",
                   1: "mostly clear day",
                   2: "partly cloudy day",
                   3: "overcast day",
                   45: "foggy day",
                   48: "foggy day with frost",
                   51: "day with light drizzle",
                   53: "day with moderate drizzle",
                   55: "day with heavy drizzle",
                   61: "day with light rain",
                   63: "day with moderate rain",
                   65: "day with heavy rain",
                   71: "day with light snow",
                   73: "day with moderate snow",
                   75: "day with heavy snow",
                   77: "day with snow grains",
                   80: "day with light rain showers",
                   81: "day with moderate rain showers",
                   82: "day with violent rain showers",
                   85: "day with light snow showers",
                   86: "day with heavy snow showers",
                   95: "stormy day",
                   96: "stormy day with light hail",
                   99: "stormy day with heavy hail"
               };

               const tempDesc = getTemperatureDescription(maxTemp, isFahrenheit);
               const weatherDesc = baseDescriptions[weatherCode] || "day";
               
               let extraDetail = "";
               if (precipitation > 0) {
                   extraDetail = ` with ${precipitation}mm of precipitation`;
               }

               return `${tempDesc} ${weatherDesc}${extraDetail}`;
           }

           function formatDate(year, month, day) {
               const date = new Date(year, month - 1, day);
               return date.toLocaleDateString('en-US', { 
                   month: 'long',
                   day: 'numeric',
                   year: 'numeric'
               });
           }

           $("#searchInput").autocomplete({
               source: function(request, response) {
                   $.ajax({
                       url: "/cities",
                       dataType: "json",
                       data: { term: request.term },
                       success: function(data) {
                           response(data.map(function(item) {
                               let label = item.city;
                               if (item.state) label += `, ${item.state}`;
                               if (item.country) label += `, ${item.country}`;
                               
                               return {
                                   label: label,
                                   value: item.city,
                                   item: item
                               };
                           }));
                       }
                   });
               },
               minLength: 2,
               select: function(event, ui) {
                   selectedCity = ui.item.item;
                   $("#searchInput").val(ui.item.label);
                   checkFormCompletion();
                   return false;
               },
               autoFocus: false,
               delay: 300
           });

           function checkFormCompletion() {
               const day = $('#dobDay').val();
               const month = $('#dobMonth').val();
               const year = $('#dobYear').val();
               const hasCity = selectedCity !== null;
               const isFriendMode = $('.mode-button.active').data('mode') === 'friend';
               const hasFriendName = !isFriendMode || $('#friendNameInput').val().trim() !== '';

               $('#getWeather').toggle(day && month && year && hasCity && hasFriendName);
           }

           async function shareResults(messageText, horoscopeText) {
               const fullMessage = `${messageText}\n\n🌟 Weather Horoscope:\n${horoscopeText}`;

               try {
                   // Try native sharing first
                   if (navigator.share) {
                       await navigator.share({
                           title: 'Birthday Weather Time Machine',
                           text: fullMessage
                       });
                       gtag('event', 'share', { 'method': 'native_share' });
                   } else {
                       // Fallback to clipboard
                       await navigator.clipboard.writeText(fullMessage);
                       showToast('Results copied to clipboard! 📋');
                       gtag('event', 'share', { 'method': 'clipboard' });
                   }
               } catch (err) {
                   if (err.name !== 'AbortError') {
                       console.error('Error sharing:', err);
                       showToast('Unable to share results 😢');
                       gtag('event', 'share_error', { 'error_type': err.name });
                   }
               }
           }

           function generateHoroscopeDisplay(horoscope) {
               return `
                   <div class="horoscope-container">
                       <div class="horoscope-header">
                           Based on the weather conditions when you were born...
                       </div>
                       <div class="horoscope-grid">
                           <div class="horoscope-column">
                               <div class="horoscope-title">Your Weather Energy</div>
                               <div class="horoscope-text">${horoscope.weather_summary}</div>
                           </div>
                           <div class="horoscope-column">
                               <div class="horoscope-title">Your Natural Traits</div>
                               <div class="horoscope-text">${horoscope.personality_traits.join('<br>')}</div>
                           </div>
                       </div>
                   </div>
               `;
           }

           function checkWeather() {
               if (!selectedCity) return;
               
               const year = $('#dobYear').val();
               const month = $('#dobMonth').val();
               const day = $('#dobDay').val();
               const date = `${year}-${month}-${day}`;
               const isFriendMode = $('.mode-button.active').data('mode') === 'friend';
               const friendName = isFriendMode ? $('#friendNameInput').val() : '';
               const formattedDate = formatDate(year, month, day);

               $('#weatherResult').html('Loading...');

               $.ajax({
                   url: "/weather",
                   data: {
                       latitude: selectedCity.latitude,
                       longitude: selectedCity.longitude,
                       date: date
                   },
                   success: function(data) {
                       if (data.daily && data.daily.temperature_2m_max) {
                           const maxTemp = isFahrenheit ? 
                               celsiusToFahrenheit(data.daily.temperature_2m_max[0]).toFixed(1) : 
                               data.daily.temperature_2m_max[0].toFixed(1);
                           const minTemp = isFahrenheit ? 
                               celsiusToFahrenheit(data.daily.temperature_2m_min[0]).toFixed(1) : 
                               data.daily.temperature_2m_min[0].toFixed(1);
                           const unit = isFahrenheit ? '°F' : '°C';
                           const weatherIcon = getWeatherIcon(data.daily.weathercode[0]);
                           const weatherDesc = getWeatherDescription(
                               data.daily.weathercode[0],
                               data.daily.temperature_2m_max[0],
                               data.daily.temperature_2m_min[0],
                               data.daily.precipitation_sum[0],
                               isFahrenheit
                           );

                           let title, messageText;
                           if (isFriendMode) {
                               title = `Happy Birthday, ${friendName}!`;
                               messageText = `On ${formattedDate} in ${selectedCity.city}, it was ${weatherDesc}!`;
                           } else {
                               title = `On ${formattedDate} in ${selectedCity.city}`;
                               messageText = `It was ${weatherDesc}!`;
                           }

                           const horoscopeHtml = generateHoroscopeDisplay(data.horoscope);

                           $('#weatherResult').html(`
                               <h3 class="birthday-message">${title}</h3>
                               <div class="weather-icon">${weatherIcon}</div>
                               <div class="weather-description">${messageText}</div>
                               <div class="temp-info">
                                   <p>High Temperature: ${maxTemp}${unit}</p>
                                   <p>Low Temperature: ${minTemp}${unit}</p>
                                   <p>Precipitation: ${data.daily.precipitation_sum[0]} mm</p>
                               </div>
                               ${horoscopeHtml}
                               <div class="share-container">
                                   <button class="share-trigger" onclick="shareResults('${messageText}', '${data.horoscope.weather_summary}')">
                                       <i class="fas fa-share-alt"></i> Share Results
                                   </button>
                               </div>
                           `);

                           gtag('event', 'view_weather_result', {
                               'weather_code': data.daily.weathercode[0],
                               'city': selectedCity.city
                           });
                       } else {
                           $('#weatherResult').html('<p class="error-message">Weather data not available for this date</p>');
                       }
                   },
                   error: function(err) {
                       $('#weatherResult').html('<p class="error-message">Failed to fetch weather data</p>');
                       gtag('event', 'error', {
                           'error_type': 'api_error',
                           'city': selectedCity?.city
                       });
                   }
               });
           }

           $('#dobDay, #dobMonth, #dobYear, #friendNameInput').on('change', checkFormCompletion);
           $('#friendNameInput').on('input', checkFormCompletion);
           $('#getWeather').on('click', checkWeather);
           $('#tempToggle').on('change', function() {
               isFahrenheit = !this.checked;
               if($('#weatherResult').html()) {
                   checkWeather();
               }
           });

           yearSelect.on('focus', function() {
               var defaultOption = $(this).find('option[value="2000"]');
               var selectElement = this;
               setTimeout(function() {
                   selectElement.scrollTop = defaultOption.offset().top - selectElement.offsetTop - (selectElement.offsetHeight / 2) + (defaultOption.height() / 2);
               }, 0);
           });
       });

       function shareResults(messageText, horoscopeText) {
           const fullMessage = `${decodeURIComponent(messageText)}\n\n🌟 Weather Horoscope:\n${decodeURIComponent(horoscopeText)}`;
           try {
               if (navigator.share) {
                   navigator.share({
                       title: 'Birthday Weather Time Machine',
                       text: fullMessage
                   }).catch(err => {
                       if (err.name !== 'AbortError') {
                           console.error('Error sharing:', err);
                           showToast('Unable to share results 😢');
                       }
                   });
               } else {
                   navigator.clipboard.writeText(fullMessage).then(() => {
                       showToast('Results copied to clipboard! 📋');
                   }).catch(err => {
                       console.error('Failed to copy:', err);
                       showToast('Unable to copy results 😢');
                   });
               }
           } catch (err) {
               console.error('Share failed:', err);
               showToast('Unable to share results 😢');
           }
       }

       function showToast(message, duration = 3000) {
           const toast = document.getElementById('toast');
           toast.textContent = message;
           toast.style.display = 'block';
           setTimeout(() => {
               toast.style.display =