<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Birthday Weather</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-38RTREJJ2S"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     gtag('config', 'G-38RTREJJ2S');
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            -webkit-font-smoothing: antialiased;
        }
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        #searchInput, select {
            width: 200px;
            padding: 12px;
            font-size: 16px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            -webkit-appearance: none;
        }
        #weatherResult {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dob-container {
            display: flex;
            margin: 20px 0;
            justify-content: center;
            gap: 15px;
        }
        .search-container {
            text-align: center;
            margin: 20px 0;
        }
        .search-button {
            padding: 12px 25px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: none;
            -webkit-appearance: none;
        }
        .toggle-container {
            margin: 20px 0;
            text-align: center;
        }
        .temp-label {
            display: inline-block;
            font-weight: bold;
            margin: 0 10px;
            color: #2c3e50;
        }
        .weather-icon {
            font-size: 64px;
            text-align: center;
            margin: 20px 0;
            line-height: 1;
        }
        .mode-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-button {
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #ecf0f1;
        }
        .mode-button.active {
            background-color: #3498db;
            color: white;
        }
        .personality-trait {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .history-tiles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 4px;
            margin: 20px 0;
        }
        .weather-tile {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
        }
        .tile-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            display: none;
        }
        .weather-tile:hover .tile-tooltip {
            display: block;
        }
        .weather-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .summary-item {
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        .prediction-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .share-button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            min-width: 200px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            display: none;
            z-index: 1000;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .dob-container {
                flex-direction: column;
                align-items: center;
            }
            #searchInput, select {
                width: 100%;
                max-width: 300px;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Birthday Weather</h1>
        <div class="subtitle">What's your birthday personality?</div>
    </div>

    <div class="mode-selector">
        <button class="mode-button active" data-mode="personal">My Birthday</button>
        <button class="mode-button" data-mode="friend">Friend's Birthday</button>
    </div>

    <div class="dob-container">
        <select id="dobMonth"></select>
        <select id="dobDay"></select>
        <select id="dobYear"></select>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Enter birthplace">
        <button id="getWeather" class="search-button">Get Weather</button>
    </div>
    
    <div class="toggle-container">
        <span class="temp-label">¬∞F</span>
        <label class="switch">
            <input type="checkbox" id="tempToggle">
            <span class="slider"></span>
        </label>
        <span class="temp-label">¬∞C</span>
    </div>

    <div id="weatherResult"></div>
    <div id="historyContainer"></div>
    
    <div id="shareContainer" style="display: none; text-align: center; margin-top: 20px;">
        <button id="shareBtn" class="share-button">
            <i class="fas fa-share-alt"></i> Share
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script>
        const websiteURL = 'www.weatherbirthday.com';
        
        $(document).ready(function() {
            let selectedCity = null;
            let isFahrenheit = true;

            function showToast(message, duration = 3000) {
                const toast = $('#toast');
                toast.text(message).fadeIn();
                setTimeout(() => toast.fadeOut(), duration);
            }

            $('.mode-button').click(function() {
                $('.mode-button').removeClass('active');
                $(this).addClass('active');
                const mode = $(this).data('mode');
                updatePlaceholders(mode);
            });

            function updatePlaceholders(mode) {
                const searchPlaceholder = mode === 'friend' ? "Enter friend's birthplace" : "Enter your birthplace";
                $('#searchInput').attr('placeholder', searchPlaceholder);
            }

            // Initialize date dropdowns
            var monthSelect = $('#dobMonth');
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            for (var i = 0; i < 12; i++) {
                monthSelect.append($('<option></option>').val((i+1).toString().padStart(2, '0')).html(months[i]));
            }

            var daySelect = $('#dobDay');
            for (var i = 1; i <= 31; i++) {
                daySelect.append($('<option></option>').val(i.toString().padStart(2, '0')).html(i));
            }

            var yearSelect = $('#dobYear');
            var currentYear = new Date().getFullYear();
            for (var i = currentYear; i >= 1940; i--) {
                yearSelect.append($('<option></option>').val(i).html(i));
            }
            yearSelect.val(2000);

            function getTemperatureColor(temp) {
                if (temp >= 35) return '#ff4444';
                if (temp >= 30) return '#ff8844';
                if (temp >= 25) return '#ffbb44';
                if (temp >= 20) return '#ffdd44';
                if (temp >= 15) return '#44aa44';
                if (temp >= 10) return '#44aaff';
                if (temp >= 5) return '#4477ff';
                return '#4444ff';
            }

            function getWeatherIcon(weatherCode) {
                const weatherIcons = {
                    0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                    51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è', 61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                    71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 77: 'üå®Ô∏è', 80: 'üåßÔ∏è', 81: 'üåßÔ∏è',
                    82: 'üåßÔ∏è', 85: 'üå®Ô∏è', 86: 'üå®Ô∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
                };
                return weatherIcons[weatherCode] || '‚ùì';
            }

            function renderHistoryTiles(data) {
                const tilesHtml = data.timeline.map(year => {
                    const temp = isFahrenheit ? (year.maxTemp * 9/5 + 32).toFixed(1) : year.maxTemp.toFixed(1);
                    const color = getTemperatureColor(year.maxTemp);
                    return `
                        <div class="weather-tile" style="background-color: ${color}">
                            ${getWeatherIcon(year.weatherCode)}
                            <div class="tile-tooltip">${year.year}: ${temp}¬∞${isFahrenheit ? 'F' : 'C'}</div>
                        </div>
                    `;
                }).join('');

                const summaryHtml = Object.entries(data.analysis.weatherTypes)
                    .map(([type, info]) => `
                        <div class="summary-item">
                            ${type}: ${info.percentage}%
                        </div>
                    `).join('');

                const predictionTemp = isFahrenheit ? 
                    (data.prediction.temperature * 9/5 + 32).toFixed(1) : 
                    data.prediction.temperature.toFixed(1);

                return `
                    <div class="history-container">
                        <h3>Your Birthday Weather History</h3>
                        <div class="history-tiles">${tilesHtml}</div>
                        <div class="weather-summary">${summaryHtml}</div>
                        <div class="prediction-box">
                            <h4>Next Birthday Forecast</h4>
                            <div class="weather-icon">${getWeatherIcon(data.prediction.weatherCode)}</div>
                            <div>${predictionTemp}¬∞${isFahrenheit ? 'F' : 'C'}</div>
                        </div>
                    </div>
                `;
            }

            async function checkWeather() {
                if (!selectedCity) return;
                
                const year = $('#dobYear').val();
                const month = $('#dobMonth').val();
                const day = $('#dobDay').val();
                const date = `${year}-${month}-${day}`;
                const mode = $('.mode-button.active').data('mode');
                const formattedDate = new Date(date).toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                $('#weatherResult').html('Loading...');
                $('#historyContainer').empty();

                try {
                    // Get current day weather
                    const weatherResponse = await $.ajax({
                        url: "/weather",
                        data: {
                            latitude: selectedCity.latitude,
                            longitude: selectedCity.longitude,
                            date: date
                        }
                    });

                    // Get historical timeline
                    const timelineResponse = await $.ajax({
                        url: "/weather/timeline",
                        data: {
                            latitude: selectedCity.latitude,
                            longitude: selectedCity.longitude,
                            month: month,
                            day: day,
                            startYear: Math.max(1940, year - 10),
                            endYear: new Date().getFullYear()
                        }
                    });

                    if (weatherResponse.daily && weatherResponse.daily.temperature_2m_max) {
                        const maxTemp = isFahrenheit ? 
                        (weatherResponse.daily.temperature_2m_max[0] * 9/5 + 32).toFixed(1) : 
                            weatherResponse.daily.temperature_2m_max[0].toFixed(1);
                        const weatherIcon = getWeatherIcon(weatherResponse.daily.weathercode[0]);
                        const unit = isFahrenheit ? '¬∞F' : '¬∞C';

                        // Main weather display
                        let html = `
                            <h2 class="text-center">${formattedDate}</h2>
                            <div class="weather-icon">${weatherIcon}</div>
                            <div style="text-align: center; font-size: 1.2em; margin: 10px 0;">
                                ${maxTemp}${unit}
                            </div>
                        `;

                        // Personality traits
                        if (weatherResponse.horoscope) {
                            html += `
                                <div style="margin: 20px 0;">
                                    ${weatherResponse.horoscope.traits.map(trait => 
                                        `<div class="personality-trait">${trait}</div>`
                                    ).join('')}
                                    ${weatherResponse.horoscope.history ? 
                                        `<div class="personality-trait">${weatherResponse.horoscope.history}</div>` : 
                                        ''}
                                </div>
                            `;
                        }

                        $('#weatherResult').html(html);

                        // Render historical weather tiles
                        if (timelineResponse && timelineResponse.timeline) {
                            $('#historyContainer').html(renderHistoryTiles(timelineResponse));
                        }

                        // Show share button
                        $('#shareContainer').show();
                        setupSharing({
                            date: formattedDate,
                            city: selectedCity.city,
                            temp: maxTemp + unit,
                            mode: mode
                        });
                    }
                } catch (error) {
                    $('#weatherResult').html('<p class="error-message">Failed to fetch weather data</p>');
                    console.error('Weather fetch error:', error);
                }
            }

            function setupSharing(data) {
                const shareBtn = document.getElementById('shareBtn');
                
                const shareText = data.mode === 'friend' ?
                    `üéÇ On your birthday in ${data.city}, it was ${data.temp}! Check your birthday weather at ${websiteURL}` :
                    `üå§Ô∏è On my birthday in ${data.city}, it was ${data.temp}! Check your birthday weather at ${websiteURL}`;

                shareBtn.onclick = async () => {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Birthday Weather',
                                text: shareText,
                                url: websiteURL
                            });
                            gtag('event', 'share', { 'method': 'native_share' });
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                try {
                                    await navigator.clipboard.writeText(shareText);
                                    showToast('Copied to clipboard! üìã');
                                    gtag('event', 'share', { 'method': 'clipboard' });
                                } catch (clipErr) {
                                    showToast('Unable to share üò¢');
                                }
                            }
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(shareText);
                            showToast('Copied to clipboard! üìã');
                            gtag('event', 'share', { 'method': 'clipboard' });
                        } catch (err) {
                            showToast('Unable to share üò¢');
                        }
                    }
                };
            }

            // City search autocomplete
            $("#searchInput").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/cities",
                        dataType: "json",
                        data: { term: request.term },
                        success: function(data) {
                            response(data.map(function(item) {
                                let label = item.city;
                                if (item.state) label += `, ${item.state}`;
                                if (item.country) label += `, ${item.country}`;
                                
                                return {
                                    label: label,
                                    value: item.city,
                                    item: item
                                };
                            }));
                        }
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    selectedCity = ui.item.item;
                    $("#searchInput").val(ui.item.label);
                    checkFormCompletion();
                    return false;
                },
                autoFocus: false,
                delay: 300
            });

            function checkFormCompletion() {
                const hasCity = selectedCity !== null;
                $('#getWeather').toggle(hasCity);
            }

            $('#dobDay, #dobMonth, #dobYear').on('change', checkFormCompletion);
            $('#getWeather').on('click', checkWeather);
            $('#tempToggle').on('change', function() {
                isFahrenheit = !this.checked;
                if($('#weatherResult').html()) {
                    checkWeather();
                }
            });

            yearSelect.on('focus', function() {
                var defaultOption = $(this).find('option[value="2000"]');
                var selectElement = this;
                setTimeout(function() {
                    selectElement.scrollTop = defaultOption.offset().top - selectElement.offsetTop - (selectElement.offsetHeight / 2) + (defaultOption.height() / 2);
                }, 0);
            });
        });
    </script>
</body>
</html>