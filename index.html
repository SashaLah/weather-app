<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Birthday Weather</title>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-38RTREJJ2S"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-38RTREJJ2S');
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* All existing styles remain exactly the same */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        #searchInput, select {
            width: 200px;
            padding: 12px;
            font-size: 16px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            -webkit-appearance: none;
        }
        #weatherResult {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .dob-container {
            display: flex;
            margin-top: 20px;
            margin-bottom: 20px;
            justify-content: center;
            gap: 15px;
        }
        .search-container {
            text-align: center;
            margin: 20px 0;
        }
        .search-button {
            padding: 12px 25px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: background-color 0.3s;
            display: none;
            -webkit-appearance: none;
        }
        .search-button:hover {
            background-color: #2980b9;
        }
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
        }
        .toggle-container {
            margin: 20px 0;
            text-align: center;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3498db;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2ecc71;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .temp-label {
            display: inline-block;
            font-weight: bold;
            color: #2c3e50;
        }
        .weather-icon {
            font-size: 120px !important;
            text-align: center;
            margin: 30px 0;
            line-height: 1;
            display: block;
        }
        .mode-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        .mode-button {
            padding: 10px 20px;
            margin: 0 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #ecf0f1;
            -webkit-appearance: none;
        }
        .mode-button.active {
            background-color: #3498db;
            color: white;
        }
        #friendNameInput {
            display: none;
            width: 200px;
            padding: 12px;
            margin: 10px auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            -webkit-appearance: none;
        }
        .friend-input-container {
            text-align: center;
            margin: 10px 0;
        }
        .horoscope-container {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .horoscope-header {
            text-align: center;
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .trait-cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .trait-card {
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 1.1em;
            line-height: 1.4;
        }
        .trait-card.sunny {
            border-left: 4px solid #f1c40f;
        }
        .trait-card.stormy {
            border-left: 4px solid #e74c3c;
        }
        .weather-description {
            font-size: 1.2em;
            margin: 20px 0;
            text-align: center;
            color: #2c3e50;
            line-height: 1.6;
            padding: 0 10px;
        }
        .birthday-message {
            font-size: 1.5em;
            margin: 15px 0;
            text-align: center;
            color: #2c3e50;
            line-height: 1.6;
            font-weight: bold;
        }
        .temp-info {
            margin: 15px 0;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ecc71;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            display: none;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: fadeInUp 0.3s ease;
        }
        .share-button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
            min-width: 200px;
            transition: background-color 0.3s;
        }
        .share-button:hover {
            background-color: #2980b9;
        }
        #twitterBtn {
            background-color: #1DA1F2;
        }
        #twitterBtn:hover {
            background-color: #1a89d0;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .dob-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            #searchInput, select {
                width: 100%;
                max-width: 300px;
                margin: 5px 0;
            }
            .trait-card {
                padding: 12px;
            }
            .weather-icon {
                font-size: 100px !important;
            }
            .share-button {
                width: 90%;
                margin: 5px auto;
            }
        }

        /* New styles for timeline feature */
        .timeline-container {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .timeline-header {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 500;
        }
        .timeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .timeline-item {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
        }
        .timeline-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .timeline-year {
            font-size: 0.9em;
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 6px;
        }
        .timeline-icon {
            font-size: 1.8em;
            margin: 6px 0;
        }
        .timeline-temp {
            font-size: 0.85em;
            color: #666;
        }
        .prediction-box {
            margin-top: 25px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        .prediction-title {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .timeline-loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .timeline-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }
            .timeline-item {
                padding: 8px;
            }
            .timeline-year {
                font-size: 0.8em;
            }
            .timeline-icon {
                font-size: 1.5em;
            }
            .timeline-temp {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Birthday Weather</h1>
        <div class="subtitle">Discover what the weather was like on the day you were born!</div>
    </div>

    <div class="mode-selector">
        <button class="mode-button active" data-mode="personal">My Birthday</button>
        <button class="mode-button" data-mode="friend">Friend's Birthday</button>
    </div>

    <div class="friend-input-container">
        <input type="text" id="friendNameInput" placeholder="Enter friend's name">
    </div>
    
    <div class="dob-container">
        <select id="dobMonth"></select>
        <select id="dobDay"></select>
        <select id="dobYear"></select>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Enter birthplace">
        <button id="getWeather" class="search-button">Get Weather</button>
    </div>
    
    <div class="toggle-container">
        <span class="temp-label">Â°F</span>
        <label class="switch">
            <input type="checkbox" id="tempToggle">
            <span class="slider"></span>
        </label>
        <span class="temp-label">Â°C</span>
    </div>

    <div id="weatherResult"></div>

    <!-- New timeline container -->
    <div id="timelineContainer" style="display: none" class="timeline-container">
        <div class="timeline-header">Your Birthday Weather History</div>
        <div id="timelineGrid" class="timeline-grid"></div>
        <div id="weatherPrediction" class="prediction-box"></div>
    </div>
    
    <div id="shareContainer" style="display: none">
        <button id="shareBtn" class="share-button">
            <i class="fas fa-share-alt"></i> Share
        </button>
        <button id="twitterBtn" class="share-button">
            <i class="fab fa-twitter"></i> Share on Twitter
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script>
        const websiteURL = 'www.weatherbirthday.com';
        
        const weatherPersonality = {
            scorchingHot: {
                bright: "You were born on a super hot day - you're full of energy and love being active",
                shadow: "Sometimes you can get a bit too heated up when things don't go your way"
            },
            sunny: {
                bright: "Born on a sunny day - you bring light and warmth to others",
                shadow: "Just like the sun, you sometimes shine too bright for others"
            },
            rainy: {
                bright: "Born on a rainy day - you're thoughtful and care deeply about others",
                shadow: "Like the rain, your emotions can overflow at times"
            },
            stormy: {
                bright: "Your stormy birthday shows you're strong and passionate",
                shadow: "Your strong personality can sometimes stir up drama"
            },
            cloudy: {
                bright: "Born under cloudy skies - you're creative and great at solving problems",
                shadow: "Like clouds, your mood can change quickly"
            },
            snowy: {
                bright: "Born on a snowy day - you're calm and bring peace to others",
                shadow: "Sometimes you can be a bit distant, like a snowy day"
            },
            cold: {
                bright: "Born on a cold day - you stay cool under pressure",
                shadow: "You might come across as a bit chilly when stressed"
            }
        };

        $(document).ready(function() {
            let selectedCity = null;
            let isFahrenheit = true;

            function showToast(message, duration = 3000) {
                const toast = $('#toast');
                toast.text(message).fadeIn();
                setTimeout(() => toast.fadeOut(), duration);
            }

            $('.mode-button').click(function() {
                $('.mode-button').removeClass('active');
                $(this).addClass('active');
                const mode = $(this).data('mode');
                $('#friendNameInput').toggle(mode === 'friend');
                updatePlaceholders(mode);
            });

            function updatePlaceholders(mode) {
                const searchPlaceholder = mode === 'friend' ? "Enter friend's birthplace" : "Enter your birthplace";
                $('#searchInput').attr('placeholder', searchPlaceholder);
            }

            var monthSelect = $('#dobMonth');
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            for (var i = 0; i < 12; i++) {
                monthSelect.append($('<option></option>').val((i+1).toString().padStart(2, '0')).html(months[i]));
            }

            var daySelect = $('#dobDay');
            for (var i = 1; i <= 31; i++) {
                daySelect.append($('<option></option>').val(i.toString().padStart(2, '0')).html(i));
            }

            var yearSelect = $('#dobYear');
            var currentYear = new Date().getFullYear();
            for (var i = currentYear; i >= 1940; i--) {
                yearSelect.append($('<option></option>').val(i).html(i));
            }
            yearSelect.val(2000);

            function celsiusToFahrenheit(celsius) {
                return (celsius * 9/5) + 32;
            }

            function getWeatherIcon(weatherCode) {
                const weatherIcons = {
                    0: 'â˜€ï¸', 1: 'ðŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ðŸŒ«ï¸', 48: 'ðŸŒ«ï¸',
                    51: 'ðŸŒ§ï¸', 53: 'ðŸŒ§ï¸', 55: 'ðŸŒ§ï¸', 61: 'ðŸŒ§ï¸', 63: 'ðŸŒ§ï¸', 65: 'ðŸŒ§ï¸',
                    71: 'ðŸŒ¨ï¸', 73: 'ðŸŒ¨ï¸', 75: 'ðŸŒ¨ï¸', 77: 'ðŸŒ¨ï¸', 80: 'ðŸŒ§ï¸', 81: 'ðŸŒ§ï¸',
                    82: 'ðŸŒ§ï¸', 85: 'ðŸŒ¨ï¸', 86: 'ðŸŒ¨ï¸', 95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
                };
                return weatherIcons[weatherCode] || 'â“';
            }

            function getTemperatureDescription(maxTemp, isFahrenheit) {
                const temp = isFahrenheit ? maxTemp : celsiusToFahrenheit(maxTemp);
                if (temp >= 90) return "a scorching hot";
                if (temp >= 80) return "a very warm";
                if (temp >= 70) return "a pleasantly warm";
                if (temp >= 60) return "a mild";
                if (temp >= 50) return "a cool";
                if (temp >= 40) return "a chilly";
                if (temp >= 30) return "a cold";
                return "a very cold";
            }

            function getWeatherDescription(weatherCode, maxTemp, minTemp, precipitation, isFahrenheit) {
                const baseDescriptions = {
                    0: "clear and sunny day",
                    1: "mostly clear day",
                    2: "partly cloudy day",
                    3: "overcast day",
                    45: "foggy day",
                    48: "foggy day with frost",
                    51: "day with light drizzle",
                    53: "day with moderate drizzle",
                    55: "day with heavy drizzle",
                    61: "day with light rain",
                    63: "day with moderate rain",
                    65: "day with heavy rain",
                    71: "day with light snow",
                    73: "day with moderate snow",
                    75: "day with heavy snow",
                    77: "day with snow grains",
                    80: "day with light rain showers",
                    81: "day with moderate rain showers",
                    82: "day with violent rain showers",
                    85: "day with light snow showers",
                    86: "day with heavy snow showers",
                    95: "stormy day",
                    96: "stormy day with light hail",
                    99: "stormy day with heavy hail"
                };

                const tempDesc = getTemperatureDescription(maxTemp, isFahrenheit);
                const weatherDesc = baseDescriptions[weatherCode] || "day";
                
                let extraDetail = "";
                if (precipitation > 0) {
                    extraDetail = ` with ${precipitation}mm of precipitation`;
                }

                return `${tempDesc} ${weatherDesc}${extraDetail}`;
            }

            // New function to fetch historical weather data
            async function fetchHistoricalWeather(latitude, longitude, month, day, startYear, endYear) {
                const weatherData = [];
                $('#timelineGrid').html('<div class="timeline-loading">Loading historical weather data...</div>');
                
                for (let year = startYear; year <= endYear; year++) {
                    const date = `${year}-${month}-${day}`;
                    try {
                        const response = await $.ajax({
                            url: "/weather",
                            data: {
                                latitude: latitude,
                                longitude: longitude,
                                date: date
                            }
                        });
                        if (response.daily?.temperature_2m_max) {
                            weatherData.push({
                                year: year,
                                maxTemp: response.daily.temperature_2m_max[0],
                                weatherCode: response.daily.weathercode[0]
                            });
                        }
                    } catch (error) {
                        console.error(`Error fetching weather for ${date}:`, error);
                    }
                }
                return weatherData;
            }

            // New function to render timeline
            function renderTimeline(weatherData) {
                const timelineGrid = $('#timelineGrid');
                timelineGrid.empty();

                weatherData.forEach(data => {
                    const weatherIcon = getWeatherIcon(data.weatherCode);
                    const temp = isFahrenheit ? 
                        celsiusToFahrenheit(data.maxTemp).toFixed(0) : 
                        data.maxTemp.toFixed(0);
                    
                    const timelineItem = $(`
                        <div class="timeline-item">
                            <div class="timeline-year">${data.year}</div>
                            <div class="timeline-icon">${weatherIcon}</div>
                            <div class="timeline-temp">${temp}${isFahrenheit ? 'Â°F' : 'Â°C'}</div>
                        </div>
                    `);
                    timelineGrid.append(timelineItem);
                });
            }

            // New function to predict next birthday weather
            function predictNextBirthday(weatherData) {
                // Calculate weather patterns
                const weatherCounts = {};
                let totalTemp = 0;
                let recentYears = weatherData.slice(-5); // Look at last 5 years

                weatherData.forEach(data => {
                    weatherCounts[data.weatherCode] = (weatherCounts[data.weatherCode] || 0) + 1;
                    totalTemp += data.maxTemp;
                });

                // Find most common weather type
                const mostCommonWeather = Object.entries(weatherCounts)
                    .sort((a, b) => b[1] - a[1])[0][0];

                // Calculate average temperature with recent years weighted more
                const avgTemp = totalTemp / weatherData.length;
                
                return {
                    weatherCode: parseInt(mostCommonWeather),
                    temperature: avgTemp,
                    confidence: (Math.max(...Object.values(weatherCounts)) / weatherData.length) * 100
                };
            }

            function formatDate(year, month, day) {
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', { 
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            function generateShareMessage(mode, data) {
                if (mode === 'friend') {
                    return `ðŸŽ‚ Happy Birthday! On your birthday in ${data.city} on ${data.date}, it was ${data.weatherDesc}! Discover your own birthday weather at ${websiteURL}`;
                } else {
                    return `ðŸŒ¤ï¸ Check out my birthday weather at ${websiteURL}! On ${data.date} in ${data.city}, it was ${data.weatherDesc}!`;
                }
            }

            function setupSharing(shareData) {
                const shareContainer = document.getElementById('shareContainer');
                const shareBtn = document.getElementById('shareBtn');
                const twitterBtn = document.getElementById('twitterBtn');
                
                shareContainer.style.display = 'block';
                
                const shareText = generateShareMessage(shareData.mode, {
                    date: shareData.date,
                    city: shareData.city,
                    weatherDesc: shareData.weatherDesc
                });

                shareBtn.onclick = async () => {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Birthday Weather',
                                text: shareText,
                                url: websiteURL
                            });
                            gtag('event', 'share', { 'method': 'native_share' });
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                try {
                                    await navigator.clipboard.writeText(shareText);
                                    showToast('Copied to clipboard! ðŸ“‹');
                                    gtag('event', 'share', { 'method': 'clipboard' });
                                } catch (clipErr) {
                                    showToast('Unable to share ðŸ˜¢');
                                    gtag('event', 'share_error', { 'error_type': 'share_failed' });
                                }
                            }
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(shareText);
                            showToast('Copied to clipboard! ðŸ“‹');
                            gtag('event', 'share', { 'method': 'clipboard' });
                        } catch (err) {
                            showToast('Unable to share ðŸ˜¢');
                            gtag('event', 'share_error', { 'error_type': 'share_failed' });
                        }
                    }
                };

                twitterBtn.onclick = () => {
                    const twitterText = encodeURIComponent(shareText);
                    window.open(`https://twitter.com/intent/tweet?text=${twitterText}`, '_blank');
                    gtag('event', 'share', { 'method': 'twitter' });
                };
            }

            $("#searchInput").autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "/cities",
                        dataType: "json",
                        data: { term: request.term },
                        success: function(data) {
                            response(data.map(function(item) {
                                let label = item.city;
                                if (item.state) label += `, ${item.state}`;
                                if (item.country) label += `, ${item.country}`;
                                
                                return {
                                    label: label,
                                    value: item.city,
                                    item: item
                                };
                            }));
                        }
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    selectedCity = ui.item.item;
                    $("#searchInput").val(ui.item.label);
                    checkFormCompletion();
                    return false;
                },
                autoFocus: false,
                delay: 300
            });

            function checkFormCompletion() {
                const day = $('#dobDay').val();
                const month = $('#dobMonth').val();
                const year = $('#dobYear').val();
                const hasCity = selectedCity !== null;
                const isFriendMode = $('.mode-button.active').data('mode') === 'friend';
                const hasFriendName = !isFriendMode || $('#friendNameInput').val().trim() !== '';

                $('#getWeather').toggle(day && month && year && hasCity && hasFriendName);
            }

            async function checkWeather() {
                if (!selectedCity) return;
                
                const year = $('#dobYear').val();
                const month = $('#dobMonth').val();
                const day = $('#dobDay').val();
                const date = `${year}-${month}-${day}`;
                const isFriendMode = $('.mode-button.active').data('mode') === 'friend';
                const friendName = isFriendMode ? $('#friendNameInput').val() : '';
                const formattedDate = formatDate(year, month, day);

                $('#weatherResult').html('Loading...');
                $('#timelineContainer').hide();

                try {
                    const response = await $.ajax({
                        url: "/weather",
                        data: {
                            latitude: selectedCity.latitude,
                            longitude: selectedCity.longitude,
                            date: date
                        }
                    });

                    if (response.daily && response.daily.temperature_2m_max) {
                        const maxTemp = isFahrenheit ? 
                            celsiusToFahrenheit(response.daily.temperature_2m_max[0]).toFixed(1) : 
                            response.daily.temperature_2m_max[0].toFixed(1);
                        const minTemp = isFahrenheit ? 
                            celsiusToFahrenheit(response.daily.temperature_2m_min[0]).toFixed(1) : 
                            response.daily.temperature_2m_min[0].toFixed(1);
                        const unit = isFahrenheit ? 'Â°F' : 'Â°C';
                        const weatherIcon = getWeatherIcon(response.daily.weathercode[0]);
                        const weatherDesc = getWeatherDescription(
                            response.daily.weathercode[0],
                            response.daily.temperature_2m_max[0],
                            response.daily.temperature_2m_min[0],
                            response.daily.precipitation_sum[0],
                            isFahrenheit
                        );

                        let title;
                        if (isFriendMode) {
                            title = `Happy Birthday, ${friendName}!`;
                        } else {
                            title = `On ${formattedDate} in ${selectedCity.city}`;
                        }

                        const shareData = {
                            mode: isFriendMode ? 'friend' : 'personal',
                            date: formattedDate,
                            city: selectedCity.city,
                            weatherDesc: weatherDesc
                        };

                        $('#weatherResult').html(`
                            <h3 class="birthday-message">${title}</h3>
                            <div class="weather-icon">${weatherIcon}</div>
                            <div class="weather-description">It was ${weatherDesc}!</div>
                            <div class="temp-info">
                                <p>High Temperature: ${maxTemp}${unit}</p>
                                <p>Low Temperature: ${minTemp}${unit}</p>
                                <p>Precipitation: ${response.daily.precipitation_sum[0]} mm</p>
                            </div>
                            ${generateHoroscopeDisplay(generateWeatherPersonality(
                                response.daily.weathercode[0],
                                response.daily.temperature_2m_max[0],
                                response.daily.precipitation_sum[0]
                            ))}
                        `);

                        setupSharing(shareData);
                        
                        // After showing current weather, fetch historical data
                        const birthYear = parseInt(year);
                        const currentYear = new Date().getFullYear();
                        const historicalData = await fetchHistoricalWeather(
                            selectedCity.latitude,
                            selectedCity.longitude,
                            month,
                            day,
                            birthYear,
                            currentYear
                        );

                        if (historicalData.length > 0) {
                            // Show timeline
                            $('#timelineContainer').show();
                            renderTimeline(historicalData);

                            // Generate and show prediction
                            const prediction = predictNextBirthday(historicalData);
                            const nextYear = currentYear + 1;
                            const predictionTemp = isFahrenheit ? 
                                celsiusToFahrenheit(prediction.temperature).toFixed(1) : 
                                prediction.temperature.toFixed(1);

                            const confidenceLevel = prediction.confidence >= 75 ? 'High' :
                                                prediction.confidence >= 50 ? 'Medium' : 'Low';

                            $('#weatherPrediction').html(`
                                <div class="prediction-title">Weather Prediction for ${nextYear}</div>
                                <div class="timeline-icon">${getWeatherIcon(prediction.weatherCode)}</div>
                                <div>Expected temperature: ${predictionTemp}${unit}</div>
                                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                    Prediction confidence: ${confidenceLevel}
                                </div>
                            `);
                        }
                        
                        gtag('event', 'view_weather_result', {
                            'weather_code': response.daily.weathercode[0],
                            'city': selectedCity.city
                        });
                    } else {
                        $('#weatherResult').html('<p class="error-message">Weather data not available for this date</p>');
                    }
                } catch (error) {
                    $('#weatherResult').html('<p class="error-message">Failed to fetch weather data</p>');
                    gtag('event', 'error', {
                        'error_type': 'api_error',
                        'city': selectedCity?.city
                    });
                }
            }

            $('#dobDay, #dobMonth, #dobYear, #friendNameInput').on('change', checkFormCompletion);
            $('#friendNameInput').on('input', checkFormCompletion);
            $('#getWeather').on('click', checkWeather);
            $('#tempToggle').on('change', function() {
                isFahrenheit = !this.checked;
                if($('#weatherResult').html()) {
                    checkWeather();
                }
            });

            yearSelect.on('focus', function() {
                var defaultOption = $(this).find('option[value="2000"]');
                var selectElement = this;
                setTimeout(function() {
                    selectElement.scrollTop = defaultOption.offset().top - selectElement.offsetTop - (selectElement.offsetHeight / 2) + (defaultOption.height() / 2);
                }, 0);
            });
        });
    </script>
</body>
</html>